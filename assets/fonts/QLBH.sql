DROP TABLE KHACHHANG
DROP TABLE VATTU
DROP TABLE HOADON
DROP TABLE CTHD

CREATE TABLE KHACHHANG(
	MAKH VARCHAR(5) PRIMARY KEY,
	TENKH NVARCHAR(30) NOT NULL,
	DIACHI NVARCHAR(50),
	DT VARCHAR(11),
	EMAIL VARCHAR(30),
	)

CREATE TABLE VATTU(
	MAVT VARCHAR(5) PRIMARY KEY,
	TENVT NVARCHAR(30) NOT NULL,
	DVT NVARCHAR(20),
	GIAMUA MONEY ,
	SLTON INT ,
	)

CREATE TABLE HOADON(
	MAHD VARCHAR(10) PRIMARY KEY,
	NGAY DATE,
	MAKH VARCHAR(5),
	TONGTG FLOAT,
	)
ALTER TABLE HOADON ADD FOREIGN KEY(MAKH) REFERENCES KHACHHANG(MAKH)

CREATE TABLE CTHD(
	MAHD VARCHAR(10),
	MAVT VARCHAR(5),
	SL INT,
	GIABAN FLOAT,
	KHUYENMAI FLOAT,
	PRIMARY KEY(MAHD,MAVT)
	)

--ALTER TABLE KHACHHANG
--ADD CONSTRAINT kt_DT CHECK(DT BETWEEN 8 AND 11);

--ALTER TABLE VATTU 
--ADD CONSTRAINT kt_GIAMUA CHECK(GIAMUA>0);
--ALTER TABLE VATTU 
--ADD CONSTRAINT kt_SLTON CHECK(SLTON>=0);

--ALTER TABLE CTHD 
--ADD CONSTRAINT kt_SL CHECK(SL>0);

INSERT INTO VATTU(MAVT,TENVT,DVT,GIAMUA,SLTON) VALUES('VT01',N'Xi măng',N'Bao',50000,5000);
INSERT INTO VATTU(MAVT,TENVT,DVT,GIAMUA,SLTON) VALUES('VT02',N'Cát',N'Khối',45000,50000);
INSERT INTO VATTU(MAVT,TENVT,DVT,GIAMUA,SLTON) VALUES('VT03',N'Gạch ống',N'Viên',120,800000);
INSERT INTO VATTU(MAVT,TENVT,DVT,GIAMUA,SLTON) VALUES('VT04',N'Gạch thẻ',N'Viên',110,800000);
INSERT INTO VATTU(MAVT,TENVT,DVT,GIAMUA,SLTON) VALUES('VT05',N'Đá lớn',N'Khối',25000,100000);
INSERT INTO VATTU(MAVT,TENVT,DVT,GIAMUA,SLTON) VALUES('VT06',N'Đá nhỏ',N'Khối',33000,100000);
INSERT INTO VATTU(MAVT,TENVT,DVT,GIAMUA,SLTON) VALUES('VT07',N'Lam gió',N'Cái',15000,50000);

INSERT INTO KHACHHANG(MAKH,TENKH,DIACHI,DT,EMAIL) VALUES('KH01',N'Nguyễn Thị Bé',N'Tân Bình','38457895','bnt@yahoo.com');
INSERT INTO KHACHHANG(MAKH,TENKH,DIACHI,DT,EMAIL) VALUES('KH02',N'Lê Hoàng Nam',N'Bình Chánh','39878987','namlehoang@gmail.com');
INSERT INTO KHACHHANG(MAKH,TENKH,DIACHI,DT,EMAIL) VALUES('KH03',N'Trần Thị Chiêu',N'Tân Bình','38457895',NULL);
INSERT INTO KHACHHANG(MAKH,TENKH,DIACHI,DT,EMAIL) VALUES('KH04',N'Mai Thị Quế Anh',N'Bình Chánh',NULL,NULL);
INSERT INTO KHACHHANG(MAKH,TENKH,DIACHI,DT,EMAIL) VALUES('KH05',N'Lê Văn Sáng',N'Quận 10',NULL,'sanglv@hcm.vnn.vn');
INSERT INTO KHACHHANG(MAKH,TENKH,DIACHI,DT,EMAIL) VALUES('KH06',N'Trần Hoàng',N'Tân Bình','38457897',NULL);

SET DATEFORMAT DMY
INSERT INTO HOADON(MAHD,NGAY,MAKH,TONGTG) VALUES('HD001','12/05/2010','KH01',NULL);
INSERT INTO HOADON(MAHD,NGAY,MAKH,TONGTG) VALUES('HD002','25/05/2010','KH02',NULL);
INSERT INTO HOADON(MAHD,NGAY,MAKH,TONGTG) VALUES('HD003','25/05/2010','KH01',NULL);
INSERT INTO HOADON(MAHD,NGAY,MAKH,TONGTG) VALUES('HD004','25/05/2010','KH04',NULL);
INSERT INTO HOADON(MAHD,NGAY,MAKH,TONGTG) VALUES('HD005','26/05/2010','KH04',NULL);
INSERT INTO HOADON(MAHD,NGAY,MAKH,TONGTG) VALUES('HD006','02/06/2010','KH03',NULL);
INSERT INTO HOADON(MAHD,NGAY,MAKH,TONGTG) VALUES('HD007','22/06/2010','KH04',NULL);
INSERT INTO HOADON(MAHD,NGAY,MAKH,TONGTG) VALUES('HD008','25/06/2010','KH03',NULL);
INSERT INTO HOADON(MAHD,NGAY,MAKH,TONGTG) VALUES('HD009','15/08/2010','KH04',NULL);
INSERT INTO HOADON(MAHD,NGAY,MAKH,TONGTG) VALUES('HD010','30/09/2010','KH01',NULL);

INSERT INTO CTHD(MAHD,MAVT,SL,KHUYENMAI,GIABAN) VALUES('HD001','VT01',5,NULL,52000);
INSERT INTO CTHD(MAHD,MAVT,SL,KHUYENMAI,GIABAN) VALUES('HD001','VT05',10,NULL,30000);
INSERT INTO CTHD(MAHD,MAVT,SL,KHUYENMAI,GIABAN) VALUES('HD002','VT03',10000,NULL,150);
INSERT INTO CTHD(MAHD,MAVT,SL,KHUYENMAI,GIABAN) VALUES('HD003','VT02',20,NULL,55000);
INSERT INTO CTHD(MAHD,MAVT,SL,KHUYENMAI,GIABAN) VALUES('HD004','VT03',50000,NULL,150);
INSERT INTO CTHD(MAHD,MAVT,SL,KHUYENMAI,GIABAN) VALUES('HD004','VT04',20000,NULL,120);
INSERT INTO CTHD(MAHD,MAVT,SL,KHUYENMAI,GIABAN) VALUES('HD005','VT05',10,NULL,30000);
INSERT INTO CTHD(MAHD,MAVT,SL,KHUYENMAI,GIABAN) VALUES('HD005','VT06',15,NULL,35000);
INSERT INTO CTHD(MAHD,MAVT,SL,KHUYENMAI,GIABAN) VALUES('HD005','VT07',20,NULL,17000);
INSERT INTO CTHD(MAHD,MAVT,SL,KHUYENMAI,GIABAN) VALUES('HD006','VT04',10000,NULL,120);
INSERT INTO CTHD(MAHD,MAVT,SL,KHUYENMAI,GIABAN) VALUES('HD007','VT04',20000,NULL,125);
INSERT INTO CTHD(MAHD,MAVT,SL,KHUYENMAI,GIABAN) VALUES('HD008','VT01',100,NULL,55000);
INSERT INTO CTHD(MAHD,MAVT,SL,KHUYENMAI,GIABAN) VALUES('HD008','VT02',20,NULL,47000);
INSERT INTO CTHD(MAHD,MAVT,SL,KHUYENMAI,GIABAN) VALUES('HD009','VT02',25,NULL,48000);
INSERT INTO CTHD(MAHD,MAVT,SL,KHUYENMAI,GIABAN) VALUES('HD010','VT01',25,NULL,57000);

SELECT * FROM CAU1
SELECT * FROM CAU2
SELECT * FROM CAU3
SELECT * FROM CAU4
SELECT * FROM CAU5
SELECT * FROM CAU6
SELECT * FROM CAU7
SELECT * FROM CAU8
SELECT * FROM CAU9
SELECT * FROM CAU10
SELECT * FROM CAU11
SELECT * FROM CAU12
SELECT * FROM CAU13
SELECT * FROM CAU14
SELECT * FROM CAU15
SELECT * FROM CAU16
SELECT * FROM CAU17
SELECT * FROM CAU18
SELECT * FROM CAU19
SELECT * FROM CAU20
SELECT * FROM CAU21
SELECT * FROM CAU22
SELECT * FROM CAU23
SELECT * FROM CAU24
SELECT * FROM CAU25
SELECT * FROM CAU26
SELECT * FROM CAU27
SELECT * FROM CAU28
SELECT * FROM CAU29
SELECT * FROM CAU30
--CÂU 1
CREATE VIEW CAU1 AS
SELECT * 
FROM KHACHHANG
WHERE DIACHI=N'Tân Bình'

--CÂU 2
CREATE VIEW CAU2 AS
SELECT *
FROM KHACHHANG
WHERE DT IS NULL

--CÂU 3
CREATE VIEW CAU3 AS
SELECT *
FROM KHACHHANG 
WHERE DT IS NULL AND EMAIL IS NULL

--CÂU 4 
CREATE VIEW CAU4 AS
SELECT *
FROM KHACHHANG
WHERE DT IS NOT NULL AND EMAIL IS NOT NULL

--CÂU 5
CREATE VIEW CAU5 AS
SELECT *
FROM VATTU
WHERE DVT=N'Cái'

--CÂU 6
CREATE VIEW CAU6 AS
SELECT *
FROM VATTU
WHERE GIAMUA>25000

--CÂU 7

CREATE VIEW CAU7 AS
SELECT *
FROM VATTU
WHERE TENVT LIKE N'Gạch%'

--CÂU 8
CREATE VIEW CAU8 AS
SELECT *
FROM VATTU 
WHERE GIAMUA BETWEEN 20000 AND 40000

--CÂU 9
CREATE VIEW CAU9 AS 
SELECT H.MAHD, H.NGAY, K.TENKH, K.DIACHI, K.DT
FROM HOADON H, KHACHHANG K
WHERE H.MAKH=K.MAKH

--CÂU 10
CREATE VIEW CAU10 AS
SELECT H.MAHD, K.TENKH, K.DIACHI, K.DT
FROM HOADON H, KHACHHANG K
WHERE H.NGAY='25-5-2010' AND H.MAKH=K.MAKH

--CÂU 11
CREATE VIEW CAU11 AS
SELECT H.MAHD, K.TENKH, K.DIACHI, K.DT
FROM HOADON H, KHACHHANG K
WHERE MONTH(H.NGAY)=6 AND H.MAKH=K.MAKH

--CÂU 12 
CREATE VIEW CAU12 AS
SELECT K.*
FROM KHACHHANG K, HOADON H
WHERE K.MAKH=H.MAKH AND MONTH(H.NGAY)=6

--CÂU 13 
CREATE VIEW CAU13 AS
SELECT DISTINCT K.*
FROM KHACHHANG K, HOADON H
WHERE K.MAKH=H.MAKH AND MONTH(H.NGAY)<>6

--CÂU 14
CREATE VIEW CAU14 AS
SELECT C.MAHD,V.MAVT,V.TENVT,V.DVT,C.GIABAN,V.GIAMUA, C.SL, ( V.GIAMUA*C.SL) AS TRIGIAMUA,(C.GIABAN*C.SL) AS TRIGIABAN 
FROM VATTU V,CTHD C
WHERE V.MAVT=C.MAVT 

--CÂU 15
CREATE VIEW CAU15 AS
SELECT C.MAHD,V.MAVT,V.TENVT,V.DVT,C.GIABAN,V.GIAMUA, C.SL, ( V.GIAMUA*C.SL) AS TRIGIAMUA,(C.GIABAN*C.SL) AS TRIGIABAN 
FROM VATTU V,CTHD C
WHERE V.MAVT=C.MAVT AND C.GIABAN >=V.GIAMUA

--CÂU 16
DROP VIEW CAU16
CREATE VIEW CAU16 AS
SELECT DISTINCT  C.MAHD,C.GIABAN,C.SL,V.*, (V.GIAMUA*C.SL) AS TRIGIAMUA,(C.GIABAN*C.SL) AS TRIGIABAN,(C.GIABAN*C.SL*10/100) KHUYENMAI
FROM VATTU V,CTHD C
WHERE V.MAVT=C.MAVT AND C.SL>100

--CÂU 17
CREATE VIEW CAU17 AS
SELECT DISTINCT V.TENVT
FROM VATTU V,CTHD C
WHERE V.MAVT=C.MAVT AND C.MAVT NOT IN(SELECT MAVT
FROM VATTU 
)

--CÂU 18
CREATE VIEW CAU18 AS
SELECT DISTINCT C.MAHD,H.NGAY,K.TENKH,K.DIACHI,K.DT,V.TENVT,V.DVT,V.GIAMUA,C.GIABAN,C.SL,(V.GIAMUA*C.SL) AS TRIGIAMUA,(C.GIABAN*C.SL) AS TRIGIABAN
FROM KHACHHANG K,VATTU V, CTHD C,HOADON H
WHERE C.MAHD=H.MAHD AND C.MAVT=V.MAVT AND K.MAKH=H.MAKH
--CÂU 19
CREATE VIEW CAU19 AS
SELECT H.MAHD,H.NGAY,K.TENKH,K.DIACHI,K.DT,V.TENVT,V.DVT,V.GIAMUA,C.GIABAN,C.SL,(V.GIAMUA*C.SL) AS TRIGIAMUA,(C.GIABAN*C.SL) AS TRIGIABAN
FROM KHACHHANG K,VATTU V, CTHD C,HOADON H
WHERE C.MAHD=H.MAHD AND C.MAVT=V.MAVT AND K.MAKH=H.MAKH AND MONTH(H.NGAY)=5
--CÂU 20
CREATE VIEW CAU20 AS
SELECT H.MAHD,H.NGAY,K.TENKH,K.DIACHI,K.DT,V.TENVT,V.DVT,V.GIAMUA,C.GIABAN,C.SL,(V.GIAMUA*C.SL) AS TRIGIAMUA,(C.GIABAN*C.SL) AS TRIGIABAN
FROM KHACHHANG K,VATTU V, CTHD C,HOADON H
WHERE C.MAHD=H.MAHD AND C.MAVT=V.MAVT AND K.MAKH=H.MAKH AND MONTH(H.NGAY)>=1 AND MONTH(H.NGAY)<=3
--CÂU 21
DROP VIEW CAU21
CREATE VIEW CAU21 AS
SELECT COUNT(C.MAHD) AS SOHD,H.NGAY,K.TENKH,K.DIACHI,H.TONGTG
FROM HOADON H,KHACHHANG K,CTHD C
WHERE	H.MAKH=K.MAKH AND C.MAHD=H.MAHD
GROUP BY H.NGAY,K.TENKH,K.DIACHI,H.TONGTG
--CÂU 22
CREATE VIEW CAU22 AS
SELECT DISTINCT TOP 1 WITH TIES COUNT(H.MAHD) AS SOHD,H.NGAY,K.TENKH,K.DIACHI,H.TONGTG
FROM HOADON H,KHACHHANG K,CTHD C
WHERE H.MAKH=K.MAKH AND C.MAHD=H.MAHD 
GROUP BY H.NGAY,K.TENKH,K.DIACHI,H.TONGTG
ORDER BY H.TONGTG
--CÂU 23
CREATE VIEW CAU23 AS
SELECT COUNT(H.MAHD) AS SOHD,H.NGAY,K.TENKH,K.DIACHI,H.TONGTG
FROM HOADON H,KHACHHANG K,CTHD C
WHERE H.MAKH=K.MAKH AND C.MAHD=H.MAHD AND  MONTH(H.NGAY)=5
GROUP BY H.NGAY,K.TENKH,K.DIACHI,H.TONGTG

--CÂU 24
CREATE VIEW CAU24 AS
SELECT K.TENKH ,COUNT(H.MAHD) AS SOHD
FROM KHACHHANG K,HOADON H,CTHD C
WHERE H.MAKH=K.MAKH AND C.MAHD=H.MAHD
GROUP BY K.TENKH
--CÂU 25
CREATE VIEW CAU25 AS
SELECT DISTINCT K.TENKH ,MONTH(H.NGAY) AS THANG ,COUNT(C.MAHD) AS SOHD
FROM KHACHHANG K,HOADON H,CTHD C
WHERE H.MAKH=K.MAKH AND C.MAHD=H.MAHD 
GROUP BY MONTH(H.NGAY),K.TENKH
--CÂU 26
CREATE VIEW CAU26 AS
SELECT DISTINCT TOP 1 WITH TIES K.*,COUNT(H.MAHD) AS SOHD
FROM KHACHHANG K,HOADON H,CTHD C
WHERE H.MAKH=K.MAKH AND C.MAHD=H.MAHD
GROUP BY K.TENKH,K.DIACHI,K.DT,K.EMAIL,K.MAKH
ORDER BY SOHD DESC
--CÂU 27
CREATE VIEW CAU27 AS
SELECT DISTINCT TOP 1 WITH TIES K.*,SUM(C.SL) AS TONGSL
FROM KHACHHANG K,HOADON H,CTHD C
WHERE H.MAKH=K.MAKH AND C.MAHD=H.MAHD
GROUP BY K.TENKH,K.DIACHI,K.DT,K.EMAIL,K.MAKH
ORDER BY TONGSL DESC
--CÂU 28
CREATE VIEW CAU28 AS
SELECT DISTINCT TOP 1 WITH TIES V.*, COUNT(C.MAHD) AS SOLANBAN
FROM VATTU V,CTHD C
WHERE V.MAVT=C.MAVT
GROUP BY V.MAVT,V.DVT,V.GIAMUA,V.SLTON,V.TENVT
ORDER BY SOLANBAN DESC
--CÂU 29
CREATE VIEW CAU29 AS
SELECT DISTINCT TOP 1 WITH TIES V.*, SUM(C.SL) AS SOLUONGBAN
FROM VATTU V,CTHD C
WHERE V.MAVT=C.MAVT
GROUP BY V.MAVT,V.DVT,V.GIAMUA,V.SLTON,V.TENVT
ORDER BY SOLUONGBAN DESC
--CÂU 30
drop view CAU30 
CREATE VIEW CAU30 AS
SELECT K.MAKH,K.TENKH,K.DIACHI,(null) as TONGSOHD
FROM KHACHHANG K
WHERE  K.TENKH NOT IN (
				SELECT K.TENKH
				FROM CTHD C,HOADON H,KHACHHANG K
				WHERE C.MAHD=H.MAHD AND H.MAKH=K.MAKH
			   )
UNION
SELECT DISTINCT K.MAKH,K.TENKH,K.DIACHI, COUNT(C.MAHD) AS TONGSOHD
FROM CTHD C,HOADON H,KHACHHANG K
WHERE C.MAHD=H.MAHD AND H.MAKH=K.MAKH
GROUP BY K.MAKH,K.TENKH,K.DIACHI
--PROC
--CAU1
drop proc p_cau1
create proc p_cau1
@x int
as
	begin
		select K.*
		from KHACHHANG K, HOADON H
		where K.MAKH=H.MAKH and @x=DAY(H.NGAY)
	end

exec p_cau1 25

--CAU2
alter proc p_cau2
@x int
as 
	begin
		select	distinct K.*
		FROM KHACHHANG K,VATTU V, CTHD C,HOADON H
		WHERE C.MAHD=H.MAHD AND C.MAVT=V.MAVT AND K.MAKH=H.MAKH and (C.SL*C.GIABAN)>@x
	end 

exec p_cau2 2500000

--CAU3
create proc p_cau3
@x int
as
	begin
		select distinct top(@x) with ties K.*,sum(C.SL*C.GIABAN) as TONGGTDH
		from KHACHHANG K,CTHD C, HOADON H
		where C.MAHD=H.MAHD and K.MAKH=H.MAKH
		group by K.TENKH, K.DIACHI,K.DT,K.EMAIL,K.MAKH
		order by TONGGTDH desc
	end

exec p_cau3 3

--CAU4
create proc p_cau4
@x int
as
	begin
		select distinct top(@x) with ties V.TENVT,sum(C.SL) as TONGSL
		from VATTU V, CTHD C
		where V.MAVT=C.MAVT
		group by V.TENVT
		order by TONGSL desc
	end

exec p_cau4 2

--CAU5
drop proc p_cau5
create proc p_cau5
@x int
as
	begin
		SELECT top(@x) with ties V.TENVT ,sum(V.GIAMUA*C.SL) AS TRIGIAMUA,sum(C.GIABAN*C.SL) AS TRIGIABAN,(sum(C.GIABAN*C.SL)-sum(V.GIAMUA*C.SL)) as LAI
		FROM KHACHHANG K,VATTU V, CTHD C,HOADON H
		WHERE C.MAHD=H.MAHD AND C.MAVT=V.MAVT AND K.MAKH=H.MAKH
		group by V.TENVT
		order by LAI asc
	end

exec p_cau5 2


--CAU6
drop proc p_cau6
create proc p_cau6
@x int
as 
	begin
		SELECT top(@x) with ties V.TENVT ,(V.GIAMUA*C.SL) AS TRIGIAMUA
		FROM VATTU V, CTHD C
		WHERE C.MAVT=V.MAVT
		group by V.TENVT,V.GIAMUA,C.SL
		order by TRIGIAMUA desc
	end

exec p_cau6 2

--CAU7
drop proc p_cau7
create proc p_cau7
as
begin
	select C.MAHD,C.MAVT,C.GIABAN,C.SL, KHUYENMAI=C.SL*C.GIABAN*5/100
	FROM CTHD C
	WHERE C.SL BETWEEN 100 AND 500
	UNION
	select C.MAHD,C.MAVT,C.GIABAN,C.SL, KHUYENMAI=C.SL*C.GIABAN*10/100
	FROM CTHD C
	WHERE C.SL>500
	UNION
	select C.MAHD,C.MAVT,C.GIABAN,C.SL, KHUYENMAI
	FROM CTHD C
	WHERE C.SL<100
end

exec p_cau7 

--CAU8
CREATE PROC p_cau8
as
	begin
		select V.TENVT,v.MAVT,v.DVT,SLTON=V.SLTON-sum(c.SL)
		from VATTU V,CTHD C
		where v.MAVT=c.MAVT
		group by v.TENVT,v.SLTON,v.MAVT,v.DVT
	end	

exec p_cau8

--CAU9
create proc p_cau9
as
	begin
		SELECT C.*, ( V.GIAMUA*C.SL) AS TRIGIAMUA,(C.GIABAN*C.SL) AS TRIGIABAN 
		FROM VATTU V,CTHD C
		WHERE V.MAVT=C.MAVT
	end 

EXEC p_cau9

--CAU10

CREATE PROC p_cau10 
AS
IF EXISTS(SELECT * FROM SYS.objects WHERE NAME = 'KH_VIP' ) 
DROP TABLE KH_VIP
CREATE TABLE KH_VIP
( 
	MAKH VARCHAR(5) PRIMARY KEY,
	TENKH NVARCHAR(30),
	DIACHI NVARCHAR(50),
	DT VARCHAR(11),
	EMAIL VARCHAR(30)
)
INSERT INTO KH_VIP 
SELECT K.*
FROM VATTU V, CTHD C, KHACHHANG K, HOADON H
WHERE V.MAVT = C. MAVT AND C.MAHD = H.MAHD AND H.MAKH=K.MAKH 
GROUP BY K.MAKH, TENKH, DIACHI, DT, EMAIL
HAVING SUM(GIABAN*SL )>= 10000000 
EXEC p_cau10

-- Function 1.	Viết hàm tính doanh thu của năm, với năm là tham số truyền vào
create function F1(@Nam int)
returns float

begin
	declare @doanhthu float
	select @doanhthu=sum(SL*GIABAN) 
	from HOADON H join CTHD C ON H.MAHD = C.MAHD
	where year(NGAY) = @Nam
	return @doanhthu
end

print N'Doanh thu năm 2010 là ' + str(dbo.F1(2010))
--CAU2
create function F2(@Nam int,@Thang int)
returns float
as
begin
	declare @doanhthu float
	select @doanhthu=sum(SL*GIABAN) 
	from HOADON H join CTHD C ON H.MAHD = C.MAHD
	where year(NGAY) = @Nam and MONTH(NGAY)=@Thang
	return @doanhthu
end

declare @Nam int,@Thang int
set @Nam=2010
set @Thang=6
print N'Doanh thu '+str(@Nam,4)+'/'+str(@Thang,2)+' la'+ str(dbo.F2(@Nam,@THang))
--CAU3
create function F3(@MAKH varchar(5))
returns float
as
begin
	declare @doanhthu float
	select @doanhthu=sum(SL*GIABAN) 
	from HOADON H join CTHD C ON H.MAHD = C.MAHD
	where MAKH=@MAKH
	return @doanhthu
end

declare @MAKH varchar(5)
set @MAKH='KH01'
print N'Doanh thu khach hang '+cast(@MAKH as varchar)+' la'+ str(dbo.F3(@MAKH))
--CAU4
create function F4(@MAVT varchar(5),@Nam int,@Thang int)
returns int
as
begin
	declare @tongsl int
	select @tongsl=sum(C.SL) 
	from HOADON H,CTHD C, VATTU V
	where C.MAVT=V.MAVT AND C.MAHD=H.MAHD
	GROUP BY V.MAVT,H.NGAY
	HAVING V.MAVT=@MAVT and year(H.NGAY) = @Nam and MONTH(H.NGAY)=@Thang
	return @tongsl
end

declare @MAVT varchar(5),@Nam int,@Thang int
set @MAVT='VT01'
SET @Nam=2010
set @Thang=5
print N'Doanh thu vat tu '+cast(@MAVT as varchar)+' '+str(@Nam,4)+'/'+str(@Thang,2)+' la'+ str(dbo.F4(@MAVT,@Nam,@Thang))